name: PostHog Session Analysis with Continue CLI Agent

on:
  schedule: 
  - cron: "0 6 * * *" # Run at 6 AM UTC daily
  workflow_dispatch: # Allow manual triggering

jobs:
  analyze:
    runs-on: ubuntu-latest

    permissions:
        contents: read
        issues: write

    steps:
    - uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: "20"

    - name: Install Continue CLI
      run: |
        echo "Installing Continue CLI..."
        npm install -g @continuedev/cli
        echo "Installation completed"
    
    - name: Debug - Verify CLI installation
      run: |
        echo "Checking if cn command is available..."
        which cn || echo "cn command not found in PATH"
        echo "Checking npm global packages..."
        npm list -g --depth=0 | grep continue || echo "Continue CLI not found in global packages"
        echo "Trying to run cn --version..."
        cn --version || echo "Failed to run cn --version"
        env:
        CONTINUE_API_KEY: ${{ secrets.CONTINUE_API_KEY }}
    
    - name: Debug - Test CLI help
      run: |
        echo "Testing cn --help..."
        cn --help || echo "Failed to run cn --help"
        env:
        CONTINUE_API_KEY: ${{ secrets.CONTINUE_API_KEY }}
    
    - name: Run Continue Agent Analysis
      env:
        CONTINUE_API_KEY: ${{ secrets.CONTINUE_API_KEY }}
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "Starting Continue Agent analysis..."
        echo "Command: cn --config 
        continuedev/awesome-models-posthog-gh -p \"Analyze PostHog sessions
        and create GitHub issues for UX problems\""
                
        set -x  # Enable command tracing
        cn --config continuedev/awesome-models-posthog-gh -p "Analyze PostHog sessions and create GitHub issues for UX problems"

        echo "Continue Agent analysis completed with exit code: $?"
    
    
    - name: Debug - Post-execution info
      if: always()  # Run even if previous steps fail
      run: |
        echo "Workflow completed"
        echo "Exit codes from previous steps:"
        echo "This step always runs to show final status"

    - name: Summary
      run: |
        echo "‚úÖ PostHog analysis workflow completed!"
        echo "üìä Check the artifacts for detailed analysis results"
        echo "üêõ Check your repository issues for newly created UX issues"
        echo "ü§ñ Agent automatically handled both analysis and issue creation"